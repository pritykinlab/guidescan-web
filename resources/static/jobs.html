<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <title>GuideScan 2.0: CRISPR Guide Design</title>
    <link rel="shortcut icon" href="/img/favicon.ico">
  </head>
  <body>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="#">Help</a></li>
        <li class="breadcrumb-item"><a href="#">Contact</a></li>
      </ol>
    </nav>

    <div class="container py-4">
      <div class="jumbotron border-top"> 
        <table>
          <tr>
            <td valign='top' width=100 rowspan="2">
              <a href="/"><img src = "/img/helix.png" width=100 margin-left20/></a>
            </td>
            <td rowspan="2">
              <h1 style="margin-left: 20px"> GuideScan 2.0</h1>
              <h3 style="margin-left: 20px"> A generalized CRISPR guideRNA design tool.</h3>
            </td>
          </tr>
        </table>
      </div>
    </div>

    <div class="container-fluid">
      <div class="col d-flex justify-content-center">
        <div class="card bg-light mb-5">
          <div class="card-body">
            {% if status = :completed %}
            <h2 class="card-title text-center">Query Job Status</h2>
            <hr></hr>

            <p class="text-success text-center" style="font-size: 1.5em;">
              Job {{job-id}} complete.
            </p>
            <div class="row justify-content-center">
              <button type="button" class="btn btn-success mx-4" onclick="show_results();">Show results</button>
              <div class="dropdown">
                <button class="btn mx-4 btn-info dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Download results
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a class="dropdown-item" href="/job/get/csv/{{job-id}}" download="results.csv">as csv...</a>
                  <a class="dropdown-item" href="/job/get/json/{{job-id}}" download="results.json">as json...</a>
                </div>
              </div>
            </div>
            {% elif status = :pending %}
            <h2 class="card-title text-center">Query Job Status</h2>
            <hr></hr>
            <p class="text-warning text-center" style="font-size: 1.5em;">
              Job {{job-id}} is still pending. Please come back later...
            </p>
            {% elif status = :failed %}
            <p class="text-danger text-center" style="font-size: 1.5em;">
              Job {{job-id}} failed.
            </p>
            <pre class="border bg-white mb-n4"> 
              <code >
                {{error-message}}
              </code>
            </pre>
            {% else %}
            <p class="text-danger text-center" style="font-size: 1.5em;">
              Job {{job-id}} was never submitted to the queue, please
              submit a job to the queue and come back later...
            </p>
            {% endif %}

            <div class="item my-3" id="table-template" style="visibility: hidden; height: 0;">
              <table id="table" class="table-light"
                     data-height="460" data-pagination="true" >
                <thead class="thead-dark">
                  <tr>
                    <th data-field="coordinate" data-sortable="true">coordinate</th>
                    <th data-field="sequence" data-sortable="true">sequence</th>
                    <th data-field="num_ots" data-sortable="true">num-off-targets</th>
                    <th data-field="ots" data-sortable="true">off-target-summary</th>
                    <th id="cutting_ef_col" data-field="cutting-efficiency" data-sortable="true">cutting-efficiency</th>
                    <th id="specificity_col" data-field="specificity" data-sortable="true">specificity</th>
                    <th data-field="annotations" data-sortable="false">annotations</th>
                  </tr>
                </thead>
              </table>
            </div>

            <div style="visibility: hidden; height: 0;" id="results">
              <hr></hr>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.17.1/dist/bootstrap-table.min.css">
    <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/bootstrap-table.min.js"></script>

    <!-- Custom JS to load results -->
    <script type="text/javascript">
      var shown_results = false;

      function off_target_summary(grna) {
          counts = {};

          if('off-targets' in grna) {
              for(const ot of grna['off-targets']) {
                  count = ot["coords"].length;

                  if (!(count in counts)) {
                      counts[ot['distance']] = 0;
                  }

                  counts[ot['distance']] += count;
              }
          } 

          return counts;
      }

      function get_table_rows(genomic_region, grnas) {
          rows = []
          
          for(var i = 0; i < grnas.length; i++) {
              grna = grnas[i];
              ots = off_target_summary(grna);
              ots2 = (2 in ots) ? ots[2] : 0;
              ots3 = (3 in ots) ? ots[3] : 0;
              
              direction = grna["direction"] == "positive" ? "+" : "-";
              num_ots = ots2 + ots3
              ots = '2:' + ots2 + ' | ' + '3:' + ots3;
              
              row = {'coordinate': genomic_region["name"],
                     'sequence': grna['sequence'],
                     'num_ots': num_ots,
                     'ots': ots}

              if(grna["annotations"].length != 0){
                  row["annotations"] = grna["annotations"][0][1];
              }

              if("cutting-efficiency" in grna){
                  row["cutting-efficiency"] = grna["cutting-efficiency"];
              } 

              if("specificity" in grna){
                  row["specificity"]= grna["specificity"];
              }

              rows.push(row);
          }
          
          return rows;
      }

      function build_tables(data){
          for (i = 0; i < data.length; i++) {
              result = data[i]
              genomic_region = result[0];
              grnas = result[1];

              all_grnas_no_specificity = true;
              for(var j = 0; i < grnas.length; j++) {
                  if("specificity" in grnas[j]){
                      all_grnas_no_specificity = false;
                      break;
                  }
              }

              all_grnas_no_cutting_ef = true;
              for(var j = 0; i < grnas.length; j++) {
                  if("cutting-efficiency" in grnas[j]){
                      all_grnas_no_cutting_ef = false;
                      break;
                  }
              }

              header = '<h4 class="font-italic font-weight-light">' +
                       genomic_region["name"] + "</h4>"
              $(header).appendTo("#results");

              template = $("#table-template").clone();
              template.prop('id', 'table-' + i);
              template.css('visibility', 'visible');
              template.css('height', '');
              template.appendTo('#results');

              if (all_grnas_no_cutting_ef) {
                  template.find('#cutting_ef_col').remove();
              }

              if (all_grnas_no_specificity) {
                  template.find('#specificity_col').remove();
              }

              template.find('#table').bootstrapTable({
                  data: get_table_rows(genomic_region, grnas)
              });
          }
      };

      function show_results() {
          if (shown_results) return;

          $.get('/job/get/json/{{job-id}}', function(data) {
              results_element = $('#results');
              build_tables(data);
              results_element.css('visibility', 'visible');
              results_element.css('height', '');
              shown_results = true;
          });
      }
    </script>
  </body>
</html>
